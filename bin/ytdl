#!/usr/bin/env python3
import sys
import subprocess
import os
import csv

def download_video(url, prefix=""):
    """Download a single video with optional prefix."""
    # Build output template
    if prefix:
        output_template = f"{os.getcwd()}/{prefix} %(title)s.%(ext)s"
    else:
        output_template = f"{os.getcwd()}/%(title)s.%(ext)s"
    
    # Build ytdlp command
    cmd = [
        "ytdlp",
        "-f", "bestvideo+bestaudio",
        "--cookies-from-browser", "brave",
        "--js-runtimes", "bun",
        "-o", output_template,
        url
    ]
    
    # Execute command
    subprocess.run(cmd)

def process_csv(csv_file):
    """Process CSV file with id,youtube_link format."""
    if not os.path.exists(csv_file):
        print(f"Error: CSV file '{csv_file}' not found")
        sys.exit(1)
    
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.reader(f)
        for row_num, row in enumerate(reader, start=1):
            if len(row) < 2:
                print(f"Warning: Skipping row {row_num} - insufficient columns")
                continue
            
            video_id = row[0].strip()
            youtube_link = row[1].strip()
            
            if not youtube_link:
                print(f"Warning: Skipping row {row_num} - empty YouTube link")
                continue
            
            print(f"Processing: {video_id} - {youtube_link}")
            download_video(youtube_link, video_id)

def main():
    if len(sys.argv) < 2:
        print("Usage: ytdl <url> [prefix] | ytdl <csv_file>")
        print("  Single video: ytdl <url> [prefix]")
        print("  CSV batch:    ytdl <csv_file> (format: id,youtube_link)")
        sys.exit(1)
    
    arg = sys.argv[1]
    
    # Check if argument is a CSV file
    if os.path.isfile(arg) and arg.endswith('.csv'):
        process_csv(arg)
    else:
        # Single URL mode
        url = arg
        prefix = sys.argv[2] if len(sys.argv) > 2 else ""
        download_video(url, prefix)

if __name__ == "__main__":
    main()